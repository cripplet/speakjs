<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article# " vocab="http://ogp.me/ns" lang="en">
<head>

<meta charset="utf-8">
<title>SpeakerJS</title>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
<script src="/static/js/modernizr.js"></script>
<script src="http://cdn.peerjs.com/0.3/peer.min.js"></script>

</head>
<body>

getUserMedia(): <span class="getusermedia">not supported</span><br/>
HTML5 audio: <span class="audio">not supported</span><br/>
RTC Peer Connection: <span class="peerconnection">not supported</span><br/>
RTC Data Channels: <span class="datachannel">not supported</span><br/>
HTML5 video: <span class="video">not supported</span><br/>
my id: <span id="home_id"></span><br/>
<input id="peer_id" type="text" /><button id="connect">connect</button><br/>
connections: <div id="peers"></div>

<audio autoplay>
<source id="inputSource" type="audio/ogg" />
</audio>

<script type="text/javascript">
var record = function(localMediaStream) {
  var url = window.URL || window.webkitURL;

  var audioRecorder = new MediaRecorder(localMediaStream);
  var audioElement = document.querySelector("audio");
  audioRecorder.start();
  // audioElement.src = url ? url.createObjectURL(localMediaStream) : localMediaStream;
  // audioElement.play();

  audioRecorder.ondataavailable = function(e) {
    console.log(e.data);
  }

  audioRecorder.onerror = function(e) {
    console.log(e);
  }
};

var failure = function(e) {
  window.alert("failure callback: could not gUM audio; did you bypass https?");
};

var connections = {};
var configConn = function(conn) {
  connections[conn.peer] = conn;
  $("#peers").append("<div id=\"" + conn.peer + "\">" + conn.peer + "</div>");
  conn.on("close", function() {
    $("#" + conn.peer).remove();
    delete connections[conn.peer];
  });
  window.addEventListener("beforeunload", function(e) {
    conn.close();
  });
}

var main = function() {
  var peer = new Peer({key: "dnu57xap0ysyvi"});
  peer.on("open", function(id) {
    $("span#home_id").text(id);
  });
  peer.on("connection", function(conn) {
    configConn(conn);
  });
  $("#connect").click(function(e) {
    var peer_id = $("#peer_id").val();
    $("#peer_id").val("");
    var conn = peer.connect(peer_id);
    if (conn.peer) {
      configConn(conn);
    }
  });

  var gUM = Modernizr.prefixed("getUserMedia", navigator);
  gUM({video: false, audio: true}, record, failure);
};



$(document).ready(function() {
  var s = 0;
  if (Modernizr.getusermedia) {
    s += 1;
    $("span.getusermedia").text("supported");
  }
  if (Modernizr.audio) {
    s += 1;
    $("span.audio").text("supported");
  }
  if (Modernizr.peerconnection) {
    s += 1;
    $("span.peerconnection").text("supported");
  }
  if (Modernizr.datachannel) {
    s += 1;
    $("span.datachannel").text("supported");
  }
  if (Modernizr.video) {
    // optional
    $("span.video").text("supported");
  }
  if (s == 4) {
    main();
  }
});
</script>

</body>

</html>
