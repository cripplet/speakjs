<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article# " vocab="http://ogp.me/ns" lang="en">
<head>

<meta charset="utf-8">
<title>SpeakerJS Client</title>

<link rel="stylesheet" type="text/css" href="https://gist.githubusercontent.com/nathansmith/288292/raw/f681bf457a90e61f535610b097117d19ca8142a5/html_reset.css" />

<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
<script type="text/javascript" src="/static/js/modernizr.js"></script>
<script type="text/javascript" src="/static/js/config.js"></script>
<script type="text/javascript" src="http://cdn.peerjs.com/0.3/peer.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.0.6/handlebars.min.js"></script>

<script id="peer_entry_template" type="text/x-handlebars-template">
  <dt id="peer_{{peer_entry_id}}_key">{{peer_entry_username}}</dt>
  <dd id="peer_{{peer_entry_id}}_val"><audio autoplay controls /></dd>
</script>

<script id="chat_entry_template" type="text/x-handlebars-template">
  <div class="log_entry">
    <span class="username">{{username}}</span> <span class="date">{{date}}</span>: <span class="message">{{message}}</span>
  </div>
</script>

<style>
  label { display: none; }
</style>

</head>
<body>

<dl id="metadata">
  <dt id="metadata_client_id_key">client</dt>
  <dd id="metadata_client_id_val"></dd>
  <dt id="metadata_client_username_key">username</dt>
  <dd id="metadata_client_username_val"></dd>
  <dt id="metadata_server_id_key">server</dt>
  <dd id="metadata_server_id_val"></dt>
  <dt id="metadata_server_metadata_key">metadata</dt>
  <dd id="metadata_server_metadata_val"></dt>
  <dt id="metadata_server_metadata_last_message_key">last message received</dt>
  <dd id="metadata_server_metadata_last_message_val"></dt>
</dl>

<dl id="peers">
  <!--
    <dt id="peer_axlk..._key">Minke</dt>
    <dd id="peer_axlk..._val">
      ...
    </dd>
    -->
</dl>

<div id="form_server_connect_wrap">
  <label for="form_server_connect_server_id">server</label>
  <input id="form_server_connect_server_id" type="text" disabled />
  <label for="form_server_connect_client_username">username</label>
  <input id="form_server_connect_client_username" type="text" disabled />
  <button id="form_server_connect_connect" disabled>connect</button>
  <button id="form_server_connect_drop" disabled>drop</button>
</div>

<div id="form_chat_wrap">
  <label for="form_chat_entry">chat</label>
  <input id="form_chat_entry" type="text" disabled />
  <button id="form_chat_submit" disabled>chat</button>
</div>

<div id="aggregated_log">
  <!--
    <div class="log_entry">...</div>
    -->
</div>

<script type="text/javascript">
var peer_entry_template = Handlebars.compile($("#peer_entry_template").html());
var chat_entry_template = Handlebars.compile($("#chat_entry_template").html());

var metadata_client_id_val = $("dd#metadata_client_id_val");
var metadata_server_id_val = $("dd#metadata_server_id_val");
var metadata_client_username_val = $("dd#metadata_client_username_val");
var metadata_server_metadata_val = $("dd#metadata_server_metadata_val");
var metadata_server_metadata_last_message_val = $("dd#metadata_server_metadata_last_message_val");

var peers = $("dl#peers");

var connect_server_id = $("input#form_server_connect_server_id");
var connect_client_username = $("input#form_server_connect_client_username");
var connect_connect = $("button#form_server_connect_connect");
var connect_drop = $("button#form_server_connect_drop");

var form_chat_entry = $("#form_chat_entry");
var form_chat_submit = $("#form_chat_submit");

var server_id = "";
var client_username = "";
var server_metadata = null;

var _cxn = new Peer(config);

var serverMetadataOnClose = function() {
  metadata_server_id_val.text("");
  metadata_client_username_val.text("");
  metadata_server_metadata_val.text("");
  metadata_server_metadata_last_message_val.text("");
  peers.empty();

  form_chat_entry.val("");

  connect_server_id.prop("disabled", false);
  connect_client_username.prop("disabled", false);
  connect_connect.prop("disabled", false);
  connect_drop.prop("disabled", true);

  form_chat_entry.prop("disabled", true);
  form_chat_submit.prop("disabled", true);
  form_chat_submit.on("click", null);

  connect_connect.on("click", connectConnectOnClick);
  connect_drop.on("click", null);
}

var serverMetadataOnOpen = function(id) {
  metadata_server_id_val.text(server_id);
  metadata_client_username_val.text(client_username);
  metadata_server_metadata_val.text("true");

  connect_server_id.val("");
  connect_client_username.val("");

  connect_server_id.prop("disabled", true);
  connect_client_username.prop("disabled", true);
  connect_connect.prop("disabled", true);
  connect_drop.prop("disabled", false);

  form_chat_entry.prop("disabled", false);
  form_chat_submit.prop("disabled", false);
  form_chat_submit.on("click", chatOnClick);

  connect_connect.on("click", null);
  connect_drop.on("click", connectDropOnClick);

  server_metadata.send(MetadataConnMessage(_cxn.id, client_username));
}

_peers = {};

var callOnStream = function(id) {
  var _callOnStream = function(stream) {
    $("audio", "#peer_" + id + "_val")[0].src = (URL || webkitURL || mozURL).createObjectURL(stream);
  }
  return _callOnStream;
}

var connectionOnData = function(id) {
  var _connectionOnData = function(data) {
    $("div#aggregated_log").prepend(chat_entry_template({
        username: _peers[id].username,
        message: data.message,
        date: formatDate(new Date(data.date))
    }));
  }
  return _connectionOnData;
}

var _metadataFuncHandlerPseudoConn = function(message) {
  $("dl#peers").append(peer_entry_template({
      peer_entry_id: message.id,
      peer_entry_username: message.username
  }));
  _peers[message.id] = {
      username: message.username,
      media: null,
      chat: null
  };
}

var _metadataFuncHandlerConn = function(message) {
  _metadataFuncHandlerPseudoConn(message);

  _peers[message.id].chat = _cxn.connect(message.id, {reliable: true})
  _peers[message.id].chat.on("data", connectionOnData(message.id));

  navigator.mediaDevices.getUserMedia({audio: true}).then(function(stream) {
    _peers[message.id].media = _cxn.call(message.id, stream),
    _peers[message.id].media.on("stream", callOnStream(message.id));
  });
}

var _metadataFuncHandlerDrop = function(message) {
  $("dt#peer_" + message.id + "_key").remove();
  $("dd#peer_" + message.id + "_val").remove();
}

var metadata_func_handler = {}
metadata_func_handler[TYPE_METADATA_CONN] = _metadataFuncHandlerConn;
metadata_func_handler[TYPE_METADATA_PSEUDOCONN] = _metadataFuncHandlerPseudoConn;
metadata_func_handler[TYPE_METADATA_DROP] = _metadataFuncHandlerDrop;

var serverMetadataOnData = function(data) {
  metadata_server_metadata_last_message_val.text(JSON.stringify(data));
  metadata_func_handler[data.type](data);
}

var connectDropOnClick = function() {
  server_metadata.send(MetadataDropMessage(_cxn.id));
  server_metadata.close();
}

var formatDate = function(date) {
  var time = [
      date.getHours().toString(),
      date.getMinutes().toString(),
      date.getSeconds().toString()
  ];

  for (var i = 0; i < time.length; i++) {
    if (time[i].length < 2) {
      time[i] = "0" + time[i];
    }
  }

  return time.join(":");
}

var chatOnClick = function() {
  var _msg = form_chat_entry.val();
  form_chat_entry.val("");
  if (!/\S/.test(_msg)) {
    return;
  }
  var date = new Date();
  var msg = {
      date: date.toString(),
      message: _msg
  };
  form_chat_entry.val("");

  for (client_id in _peers) {
    if (_peers[client_id].chat) {
      _peers[client_id].chat.send(msg);
    } else {
      $("div#aggregated_log").prepend(chat_entry_template({
          username: _peers[client_id].username,
          message: msg.message,
          date: formatDate(new Date(msg.date))
      }));
    }
  }
}

var connectConnectOnClick = function() {
  server_id = connect_server_id.val();
  client_username = connect_client_username.val() ? connect_client_username.val() : server_id;

  if (server_id == "" || (server_metadata != null && !server_metadata.open)) {
    // TODO(minkezhang): bug, may have a leak on server_metadata.close
    return;
  }

  server_metadata = _cxn.connect(server_id, {
      reliable: true,
      metadata: {
          channel: METADATA,
          username: client_username
      }
  });

  server_metadata.on("open", serverMetadataOnOpen);
  server_metadata.on("close", serverMetadataOnClose);
  server_metadata.on("data", serverMetadataOnData);
}

var cxnOnConnection = function(datachannel) {
  _peers[datachannel.peer].chat = datachannel;
  _peers[datachannel.peer].chat.on("data", connectionOnData(datachannel.peer));
}

var cxnOnCall = function(call) {
  navigator.mediaDevices.getUserMedia({audio: true}).then(function(stream) {
    _peers[call.peer].media = call;
    _peers[call.peer].media.answer(stream);
    _peers[call.peer].media.on("stream", callOnStream(call.peer));
  });
}

var cxnOnOpen = function(id) {
  metadata_client_id_val.text(id);

  connect_server_id.prop("disabled", false);
  connect_client_username.prop("disabled", false);
  connect_connect.prop("disabled", false);
  connect_drop.prop("disabled", true);

  form_chat_entry.prop("disabled", true);
  form_chat_submit.prop("disabled", true);
  form_chat_submit.on("click", null);

  connect_connect.on("click", connectConnectOnClick);
  connect_drop.on("click", null);
}

var cxnOnClose = function() {
  metadata_client_id_val.text("");

  connect_server_id.prop("disabled", true);
  connect_client_username.prop("disabled", true);
  connect_connect.prop("disabled", true);
  connect_drop.prop("disabled", true);

  form_chat_entry.prop("disabled", true);
  form_chat_submit.prop("disabled", true);
  form_chat_submit.on("click", null);

  connect_connect.on("click", null);
  connect_drop.on("click", null);
}

$(document).ready(function() {
  logSupportStatus();

  _cxn.on("open", cxnOnOpen);
  _cxn.on("close", cxnOnClose);

  _cxn.on("connection", cxnOnConnection);
  _cxn.on("call", cxnOnCall);

  window.addEventListener("unload", function(e) {
    _cxn.destroy();
  });
});
</script>

</body>

</html>
