<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article# " vocab="http://ogp.me/ns" lang="en">
<head>

<meta charset="utf-8">
<title>SpeakerJS</title>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
<script src="/static/js/modernizr.js"></script>
<script src="http://cdn.peerjs.com/0.3/peer.min.js"></script>

</head>
<body>

CLIENT: <span id="home_id"></span><br/>
PEERS: <div id="peers"></div>
server: <span id="server_id"></span><br/>
connected_to_server: <span id="server_conn_status">false</span><br/>
connected_to_server_chat: <span id="server_chat_status">false</span><br/>
connected_to_server_voice: <span id="server_voice_status">false</span><br/>
username: <span id="username"></span><br/>
<div id="connect_div"></div>
<input id="input_chat" type="text" />
<button id="button_chat">send</button>
LOG
<div id="log"></div>

<audio autoplay>
<source id="inputSource" type="audio/ogg" />
</audio>

<script type="text/javascript">
var form = `
<input id="server_id_input" type="text" />
<input id="input_username" type="text" />
<button id="connect">connect</button><br/>
`

var configFromServerConn = function(conn) {
}

var configChatConn = function(conn) {
  conn.on("open", function() {
    $("#server_chat_status").text(conn.open);
    $("#button_chat").click(function(e) {
      var m = $("#input_chat").val();
      conn.send(m);
      $("#input_chat").val("");
    });
    conn.on("data", function(data) {
      if (data["type"] === 0) { // normal message
        var str_msg = data["username"] + ": " + data["message"];
        $("#log").prepend($("<div>").text(str_msg));
      }
    });
  });
  conn.on("close", function() {
    $("#server_chat_status").text("false");
  });
}

var configMetadataConn = function(conn, username, peer) {
  var connections = {};
  conn.on("open", function() {
    $("#server_conn_status").text(conn.open);
    conn.send({"type": 0, "username": username});
    $("#input_username").val("");
    $("#username").text(username);

    conn.on("data", function(data) {
      if (data["type"] === 1) {
        if ($("#" + data["id"]).length) {  // rename
          $("#" + data["id"]).text(data["username"]);
        } else {
          connections[data["id"]] = {};
          var new_peer = $("<div>");
          new_peer.attr("id", data["id"]);

          var peer_id = $("<span>");
          peer_id.text(data["username"]);
          peer_id.attr("class", "peer_id");

          var peer_status = $("<span>");
          peer_status.attr("class", "voice_stat");
          peer_status.text("false");

          new_peer.append(peer_id);
          new_peer.append($("<br/>"));
          new_peer.append(peer_status);

          // TODO: remove if c == self
          var peer_audio = $("<div>");
          peer_audio.html("<audio autoplay />");
          new_peer.append(peer_audio);

          $("#peers").append(new_peer);
        }
      } else if (data["type"] === 2) {
        $("#" + data["id"]).remove();
      } else if (data["type"] === 3) {
        $("#server_voice_status").text("true");
      }
    });

    peer.on("call", function(call) {
      if ($("#" + call.metadata["label"]).length) {
        call.answer();
        call.on("stream", function(stream) {
          if (!connections[call.metadata["label"]].hasOwnProperty("voice")) {
            $(".voice_stat", "#" + call.metadata["label"]).text(call.open);
            connections[call.metadata["label"]]["voice"] = call;

            // TODO: filter if c == self
            var aud = $("audio", "#" + call.metadata["label"])[0];
            aud.src = (URL || webkitURL || mozURL).createObjectURL(stream);
          }
        });
      }
    });

    navigator.mediaDevices.getUserMedia({video: false, audio: true}).then(function(stream) {
      peer.call(conn.peer, stream);
    }).catch(function(e) {
    });
  });
  conn.on("close", function() {
    // reset
    $("#username").text("");
    $("#server_conn_status").text("false");
    $("#server_id").text("");
    $("#peers").html("");
    $("#connect_div").html(form);
  });
}

var main = function() {
  $("#connect_div").html(form);

  var peer = new Peer({
      key: "dnu57xap0ysyvi",
      config: {
          "iceServers": [
              { url: "stun:stun.l.google.com:19302" },
              { url: "turn:numb.viagenie.ca", username: "webrtc@live.com", credential: "muazkh" } 
          ]
      }
  });
  window.addEventListener("unload", function(e) {
    peer.destroy();
  });

  peer.on("open", function(id) {
    $("span#home_id").text(id);
  });

  peer.on("connection", function(conn) {
    configFromServerConn(conn);
  });

  peer.on("error", function(e) {
    console.log(e);
  });

  $("#connect").click(function(e) {
    var server_id = $("#server_id_input").val();
    $("#server_id_input").val("");
    $("#server_id").text(server_id);
    var username = $("#input_username").val();
    var metadataConn = peer.connect(server_id, {"reliable": true, "label": "metadata"}); // TCP for metadata
    if (metadataConn.peer) {
      configMetadataConn(metadataConn, username, peer);
    }
    var chatConn = peer.connect(server_id, {"reliable": true, "label": "chat"});
    if (chatConn.peer) {
      configChatConn(chatConn);
      $("#connect_div").html("");
    }
  });
};

$(document).ready(function() { main(); });
</script>

</body>

</html>
